{% extends "layout.html" %}

{% block content %}
<h2 class="mb-4">予約フォーム</h2>

<form method="POST" action="{{ url_for('reservation.reserve') }}" class="card p-4 shadow-sm">

    <!-- LINE からのアクセスかどうか -->
    <input type="hidden" id="line_user_id" name="line_user_id">

    <div class="mb-3">
        <label class="form-label">お名前</label>
        <input type="text" name="customer_name" id="customer_name"
               class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">電話番号</label>
        <input type="text" name="phone" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">メニュー（時間）</label>
        <select name="duration" class="form-select">
            <option value="60">60分</option>
            <option value="90">90分</option>
            <option value="120">120分</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">予約日</label>
        <input type="date" name="date" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">開始時間（10分単位）</label>
        <select name="time" class="form-select" required>
            {% for h in range(9, 22) %}  {# 9:00〜21:59 #}
                {% for m in [0, 10, 20, 30, 40, 50] %}
                    <option value="{{ '%02d:%02d' % (h, m) }}">
                        {{ '%02d:%02d' % (h, m) }}
                    </option>
                {% endfor %}
            {% endfor %}
            <option value="22:00">22:00</option>  {# 営業終了時間ジャスト #}
        </select>
    </div>



    <button class="btn btn-primary w-100">予約する</button>
</form>
<!-- 必須：LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- LIFF JavaScript 読み込み -->
<script src="{{ url_for('static', filename='js/liff.js') }}"></script>

<script>
async function loadTimes() {
    const date = document.getElementById("date").value;
    const duration = document.getElementById("duration").value;

    if (!date) return;

    const res = await fetch(`/api/time-slots?date=${date}&duration=${duration}`);
    const data = await res.json();

    const sel = document.getElementById("time");
    sel.innerHTML = "";

    data.time_slots.forEach(ts => {
        let opt = document.createElement("option");
        opt.value = ts;
        opt.textContent = ts;

        // 無効化
        if (data.disabled.includes(ts)) {
            opt.disabled = true;
            opt.classList.add("disabled-option");
        }

        sel.appendChild(opt);
    });
}
document.getElementById("date").addEventListener("change", loadTimes);
document.getElementById("duration").addEventListener("change", loadTimes);
</script>

{% endblock %}
